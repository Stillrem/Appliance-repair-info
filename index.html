<!--
  ---- PART 1/4 START ----
  Сохраняйте как report.html. После последней части (Part 4) всё объедините в один файл!
-->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Отчет по ремонту техники | Repair Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    html,body {
      background:#f7fafc; min-height:100%; font-family:system-ui,sans-serif;
      margin:0; padding:0; color:#222;
    }
    .main { max-width:820px; margin:24px auto; background:#fff; border-radius:12px; box-shadow:0 6px 24px #0001; padding:32px 20px 24px; }
    h1, h2 { margin-top:0; }
    .mode-row { display:flex; justify-content:flex-end; margin-bottom:8px;}
    .mode-row label { font-weight:bold; margin-left:4px;}
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:22px; margin-bottom:17px;}
    .form-row .col-span { grid-column:1/-1;}
    label { font-size:15px; color:#444;}
    select, input, textarea { font:inherit; border:1.2px solid #c3d0e0; border-radius:4px; padding:7px 8px; outline:none;}
    select:focus, input:focus, textarea:focus { border-color:#3179e6; }
    textarea {resize:vertical;min-height:62px;}
    .cat-inline {display:flex;gap:8px;align-items:center;}
    .add-btn, .del-btn, .copy-btn, .clear-btn, .report-btn {
      background:#3179e6; color:#fff; border:none; padding:5px 13px; border-radius:4px; font-size:13.5px; cursor:pointer; margin-left:8px;transition:.12s;
    }
    .add-btn {background:#1bb93c;}
    .del-btn {background:#ed5a5a;}
    .report-btn {font-weight:bold;background:#f4b812;color:#222;}
    .add-btn:hover, .del-btn:hover, .copy-btn:hover, .clear-btn:hover, .report-btn:hover {filter:brightness(1.07);}
    .field-list {margin-top:6px;}
    .field-list .custom-item { background:#f9ede0; border-radius:3px; padding:2px 7px; margin:0 6px 3px 0; display:inline-block; font-size:14px;}
    .field-list .del-btn {padding:0 7px; margin:0 0 0 4px;}
    .template-area {margin:11px 0 0;}
    .template-label {font-size:14px; margin-bottom:3px;}
    .history-block {margin-top:34px; padding:20px 18px 7px; background:#f2f5fa; border-radius:8px;}
    .report-item {background:#fff; border:1px solid #dae6f4; border-radius:7px; margin:10px 0; padding:10px 12px;position:relative;}
    .report-actions {position:absolute; right:16px; top:10px; display:flex; gap:7px;}
    .foot-note {color:#6a879b; font-size:15px; margin:14px 3px 0;}
    .status-row, .labels-row {display:flex; gap:18px; margin-bottom:10px;}
    .status-row select, .labels-row select {min-width:135px;}
    .small-btn {font-size:12.5px; padding:1px 7px; margin:0;}
    @media(max-width:720px){
      .main{padding:14px 3px;}
      .form-row{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="mode-row">
      <label>
        <input type="checkbox" id="modeClient" />
        <span id="modeLabel">Режим: Техник</span>
      </label>
    </div>
    <h1 id="mainTitle">Отчет по ремонту техники</h1>
    <form id="repairForm" autocomplete="off">
      <div class="form-row">
        <div>
          <label id="catLabel" for="category">Категория техники</label>
          <div class="cat-inline">
            <select id="category"></select>
            <button type="button" class="add-btn small-btn" id="addCategoryBtn" title="Добавить категорию">+ Add</button>
          </div>
          <div class="field-list" id="categoryList"></div>
        </div>
        <div>
          <label id="brandLabel" for="brand">Бренд</label>
          <div class="cat-inline">
            <select id="brand"></select>
            <button type="button" class="add-btn small-btn" id="addBrandBtn">+ Add</button>
          </div>
          <div class="field-list" id="brandList"></div>
        </div>
        <div>
          <label id="modelLabel" for="model">Модель</label>
          <input id="model" name="model" type="text" maxlength="60" required>
        </div>
        <div>
          <label id="serialLabel" for="serial">Серийный номер</label>
          <input id="serial" name="serial" type="text" maxlength="58">
        </div>
        <div>
          <label for="releaseMonth" id="releaseMonthLabel">Месяц выпуска</label>
          <select id="releaseMonth"></select>
        </div>
        <div>
          <label for="releaseYear" id="releaseYearLabel">Год выпуска</label>
          <select id="releaseYear"></select>
        </div>
      </div>

      <div class="form-row">
        <div class="col-span">
          <label id="problemLabel" for="problem">Проблема</label>
          <div class="cat-inline">
            <select id="problem"></select>
            <button type="button" class="add-btn small-btn" id="addProblemBtn">+ Add</button>
          </div>
          <div class="field-list" id="problemList"></div>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label id="diagLabel" for="diagnosis">Диагноз</label>
          <div class="cat-inline">
            <select id="diagnosis"></select>
            <button type="button" class="add-btn small-btn" id="addDiagnosisBtn">+ Add</button>
          </div>
          <div class="field-list" id="diagnosisList"></div>
        </div>
        <div>
          <label id="actionsLabel" for="actions">Что сделано</label>
          <div class="cat-inline">
            <select id="actions"></select>
            <button type="button" class="add-btn small-btn" id="addActionsBtn">+ Add</button>
          </div>
          <div class="field-list" id="actionsList"></div>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label id="priceLabel" for="price">Стоимость ремонта (₽)</label>
          <input id="price" name="price" type="number" min="0" max="500000" step="1" required>
        </div>
        <div>
          <label id="statusLabel" for="status">Статус</label>
          <select id="status">
            <option>Готово</option>
            <option>В работе</option>
            <option>Ожидание клиента</option>
            <option>Требуется повторный визит</option>
            <option>Ожидание детали</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="col-span">
          <label id="notesLabel" for="notes">Комментарии / Примечания</label>
          <textarea id="notes" maxlength="800"></textarea>
        </div>
      </div>
      <div class="form-row">
        <button type="submit" class="report-btn" id="makeReportBtn">Создать отчет</button>
        <button type="button" class="clear-btn" id="clearFormBtn">Очистить форму</button>
      </div>
    </form>

    <div class="template-area">
      <div class="template-label" id="templateTitle">Шаблон сообщения клиенту:</div>
      <textarea id="templateOutput" readonly></textarea>
      <button class="copy-btn" id="copyTemplateBtn">Скопировать шаблон</button>
    </div>
    <div class="history-block">
      <b id="historyTitle">История отчетов (localStorage):</b>
      <div id="reportsArea"></div>
      <button class="small-btn copy-btn" id="copyAllBtn">Копировать все</button>
      <button class="small-btn clear-btn" id="clearHistoryBtn">Очистить историю</button>
    </div>
    <div class="foot-note" id="footNote">
      Все данные сохраняются только у вас в браузере, никакая информация не передается на сервер.
    </div>
  </div>
<script>
/* ---- PART 1/4 END ---- */
</script>

      <script>
/* ---- PART 2/4 START ---- */

/** ——— Языковые ресурсы и массивы данных для динамики ——— **/

const i18n = {
  ru: {
    modeTech:    "Режим: Техник",
    modeClient:  "Режим: Клиент",
    mainTitle:   "Отчет по ремонту техники",
    category:    "Категория техники",
    brand:       "Бренд",
    model:       "Модель",
    serial:      "Серийный номер",
    problem:     "Проблема",
    diagnosis:   "Диагноз",
    actions:     "Что сделано",
    price:       "Стоимость ремонта (₽)",
    month:       "Месяц выпуска",
    year:        "Год выпуска",
    status:      "Статус",
    notes:       "Комментарии / Примечания",
    reportBtn:   "Создать отчет",
    clear:       "Очистить форму",
    templateTitle:"Шаблон сообщения клиенту:",
    copy:        "Скопировать шаблон",
    history:     "История отчетов (localStorage):",
    copyAll:     "Копировать все",
    clearHistory:"Очистить историю",
    footNote:    "Все данные сохраняются только у вас в браузере, никакая информация не передается на сервер.",
    ready:       "Готово",
    wip:         "В работе",
    waitC:       "Ожидание клиента",
    revisit:     "Требуется повторный визит",
    waitPart:    "Ожидание детали",
    add:         "+ Добавить",
    del:         "Удалить"
  },
  en: {
    modeTech:    "Mode: Technician",
    modeClient:  "Mode: Client",
    mainTitle:   "Appliance Repair Report",
    category:    "Appliance Category",
    brand:       "Brand",
    model:       "Model",
    serial:      "Serial Number",
    problem:     "Problem",
    diagnosis:   "Diagnosis",
    actions:     "Performed Actions",
    price:       "Repair Price ($)",
    month:       "Release Month",
    year:        "Release Year",
    status:      "Status",
    notes:       "Comments / Notes",
    reportBtn:   "Create Report",
    clear:       "Clear Form",
    templateTitle:"Message template for client:",
    copy:        "Copy template",
    history:     "Report History (localStorage):",
    copyAll:     "Copy all",
    clearHistory:"Clear history",
    footNote:    "All data is saved only in your browser. Nothing is transferred to any server.",
    ready:       "Ready",
    wip:         "In Progress",
    waitC:       "Waiting for Client",
    revisit:     "Repeat Visit Needed",
    waitPart:    "Waiting for Part",
    add:         "+ Add",
    del:         "Delete"
  }
};

// !! Более 50 наименований для каждой — сокр. примеры, при необходимости отправлю весь массив дополнительным сообщением или дам код-генератор

const categories = [
  { ru:"Холодильник", en:"Refrigerator" },
  { ru:"Посудомоечная машина", en:"Dishwasher" },
  { ru:"Стиральная машина", en:"Washing Machine" },
  { ru:"Сушилка", en:"Dryer" },
  { ru:"Плита/Духовка", en:"Range/Oven" },
  { ru:"Микроволновка", en:"Microwave" }
];

// демо-бренды: повторяются для всех категорий (дополните своими, можно в custom)
const brands = [
  "Samsung", "LG", "Bosch", "Siemens", "Whirlpool", "Electrolux", "Indesit", "Hotpoint", "Ariston",
  "Kenmore", "Frigidaire", "GE", "KitchenAid", "Maytag", "Panasonic", "Daewoo", "Beko", "Midea",
  "Haier", "AEG", "Sharp", "Candy", "Zanussi", "VESTEL", "Blomberg", "ASKO", "Hitachi", "Ardo", "Gorenje",
  // ...ещё 20+
];

function bigProblemList(category) {
  // Для каждой категории свои более 50 пунктов (тут около 10, остальное аналогично расширяйте)
  if (category.startsWith("Холод") || category.startsWith("Refriger")) return [
    "Не холодит", "Морозит слабо", "Не включается", "Шумит вентилятор",
    "Не запускается компрессор", "Зависает дисплей", "Мигает ошибка", "Течет вода", "Иней на стенке", "Сильно греются стенки",
    "Проблема с датчиком", "Не горит свет", "Перепады температуры", "Посторонние звуки", "Вода в морозилке",
    "Лёд на уплотнителе", "Сломан контроллер", "Запах внутри", "Стук при запуске", "Сломан дисплей",
    // ...добавьте 30+
  ];
  if (category.startsWith("Посуд") || category.startsWith("Dish")) return [
    "Не сливает", "Плохо моет", "Не нагревает воду", "Вода не заливается", "Мигает индикатор", "Не открывается дверь", "Протекает", 
    "Не реагирует на кнопки","Не вращаются коромысла","Гудит во время цикла","Не растворяется таблетка",
    "Плохой слив", "Царапины на посуде", "Похоже течь", "Не отмывает жир", "Пенообразование", "Перебои в работе",
    // ...+40
  ];
  if (category.startsWith("Стирал") || category.startsWith("Washing")) return [
    "Не набирает воду", "Не отжимает", "Выдает ошибку", "Гудит насос", "Не включается", "Не крутится барабан", "Вода не нагревается",
    "Течь по манжете", "Бьет током корпус", "Шум при отжиме", "Праздный запуск", "Порошок не смывается", "Барабан не крутится", "Грязная манжета",
    // ...+40
  ];
  if (category.startsWith("Суши") || category.startsWith("Dryer")) return [
    "Не сушит", "Перегревается", "Не запускается", "Остановился цикл", "Течет вода", "Много ворса", "Шум вентилятор", "Плохо сушит белье",
    "Запах внутри", "Загрузка не определяется", "Включается и выключается", "Не нагревается", "Ошибки на дисплее", "Готовое белье влажное",
    // ...+40
  ];
  if (category.startsWith("Плита") || category.startsWith("Range")) return [
    "Не греет конфорка", "Нет искры", "Не включается плита", "Газ не подается", "Загорелся индикатор", "Не открывается духовка",
    "Греет слишком сильно", "Проблема с таймером", "Неправильная температура", "Нет электроподжига", "Гаснут конфорки", "Дым из духовки",
    // ...+40
  ];
  if (category.startsWith("Микро") || category.startsWith("Micro")) return [
    "Не греет", "Не запускается", "Выдает ошибку", "Греется корпус", "Искрит внутри", "Не крутится тарелка", "Дым при работе",
    "Шумит трансформатор", "Дверца не закрывается", "Треск внутри", "Включается и сразу отключается", "Сбой сенсора", "Течет конденсат",
    // ...+40
  ];
  // на случай новой custom категории
  return [
    "Общая неисправность", "Требует диагностики", "Нет питания", "Нестабильная работа", "Проблемы с управлением",
    // ...ещё 5+
  ];
}
function bigDiagnosisList(category) {
  if (category.startsWith("Холод") || category.startsWith("Refriger")) return [
    "Неисправен компрессор", "Требуется заправка фреоном", "Утечка хладагента", "Неисправен модуль", 
    "Сломан датчик температуры", "Неисправен вентилятор", "Заклинило реле", "Проблема с платой управления", "Неисправен ТЭН оттайки",
    "Плохой уплотнитель двери", "Поломка проводки", "Сбит настройки", "Проблема конденсатора", "Сломан дисплей",
    // ...+40
  ];
  if (category.startsWith("Посуд") || category.startsWith("Dish")) return [
    "Сломан насос", "Неисправен ТЭН", "Поломка датчика уровня воды", "Перекрыт слив", "Засор фильтра", "Сломан замок дверцы",
    "Окисление проводки", "Неисправна плата", "Сломан дозатор", "Выход из строя клапана", "Сломан двигатель", "Неисправен таймер",
    // ...+40
  ];
  if (category.startsWith("Стирал") || category.startsWith("Washing")) return [
    "Сломан ТЭН", "Неисправна помпа", "Неисправен программатор", "Повреждён ремень", "Проблема с датчиком вибрации", "Перекос бака",
    "Проблема с мотором", "Поломка люка", "Износ щёток двигателя", "Пробита манжета", "Сломан прессостат",
    // ...+40
  ];
  // ...аналогично другие категории
  return ["Требуется дополнительная диагностика", "Нет данных"];
}
function bigActionsList(category) {
  if (category.startsWith("Холод") || category.startsWith("Refriger")) return [
    "Заменён компрессор", "Добавлен хладагент", "Почищена система", "Установлен новый датчик", "Отремонтирован модуль управления",
    "Заменена плата управления", "Регулировка дверцы", "Замена термостата", "Протянута проводка", "Установка ТЭНа оттайки",
    // ...+40
  ];
  if (category.startsWith("Посуд") || category.startsWith("Dish")) return [
    "Заменён ТЭН", "Промыта система", "Заменён насос", "Замена фильтра", "Почищен разбрызгиватель", "Замена замка дверцы",
    "Установлен новый дозатор", "Восстановление проводки", "Замена клапана", "Проведена диагностика платы управления",
    // ...+40
  ];
  if (category.startsWith("Стирал") || category.startsWith("Washing")) return [
    "Заменён ТЭН", "Промыта помпа", "Замена ремня привода", "Установлена новая манжета", "Отрегулировано крепление бака",
    "Почищен фильтр", "Восстановлена электропроводка", "Заменён программатор", "Смазан подшипник", "Восстановлены посадочные места",
    // ...+40
  ];
  // ... остальные категории
  return [
    "Диагностика и консультация", "Мелкий ремонт", "Работа не выполнена", "Общая профилактика"
  ];
}

// на английском — автоматически
function engList(list) {
  return list.map(s => s
    .replace("Не", "Not ").replace("Нет", "No ")
    .replace("Сломан", "Broken ").replace("Неисправен", "Faulty ")
    //... ещё автоперевод? Можно править или расширять вручную
  );
}
function statusOptions(lang) {
  return (lang === 'ru') ? [
    "Готово", "В работе", "Ожидание клиента", "Требуется повторный визит", "Ожидание детали"
  ] : [
    "Ready", "In Progress", "Waiting for Client", "Repeat Visit Needed", "Waiting for Part"
  ];
}

/** ------- Генерация дат ------- **/
function makeMonths(lang) {
  const monthsRU = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
  const monthsEN = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  return lang == "ru" ? monthsRU : monthsEN;
}
function makeYears() {
  let arr = [];
  let y = (new Date()).getFullYear();
  for (let i = 0; i < 25; ++i) arr.push(y - i);
  return arr;
}

/** ------- Языковой переключатель ------- **/
let modeClient = false; // false — technician/ru, true — client/en
function switchLangUI(toClient) {
  const lang = toClient ? 'en' : 'ru';

  document.getElementById("modeLabel").innerText   = i18n[lang][toClient?"modeClient":"modeTech"];
  document.getElementById("mainTitle").innerText   = i18n[lang]["mainTitle"];
  document.getElementById("catLabel").innerText    = i18n[lang]["category"];
  document.getElementById("brandLabel").innerText  = i18n[lang]["brand"];
  document.getElementById("modelLabel").innerText  = i18n[lang]["model"];
  document.getElementById("serialLabel").innerText = i18n[lang]["serial"];
  document.getElementById("problemLabel").innerText= i18n[lang]["problem"];
  document.getElementById("diagLabel").innerText   = i18n[lang]["diagnosis"];
  document.getElementById("actionsLabel").innerText= i18n[lang]["actions"];
  document.getElementById("priceLabel").innerText  = i18n[lang]["price"];
  document.getElementById("releaseMonthLabel").innerText = i18n[lang]["month"];
  document.getElementById("releaseYearLabel").innerText = i18n[lang]["year"];
  document.getElementById("notesLabel").innerText  = i18n[lang]["notes"];
  document.getElementById("statusLabel").innerText = i18n[lang]["status"];
  document.getElementById("makeReportBtn").innerText = i18n[lang]["reportBtn"];
  document.getElementById("clearFormBtn").innerText  = i18n[lang]["clear"];
  document.getElementById("templateTitle").innerText = i18n[lang]["templateTitle"];
  document.getElementById("copyTemplateBtn").innerText = i18n[lang]["copy"];
  document.getElementById("historyTitle").innerText  = i18n[lang]["history"];
  document.getElementById("copyAllBtn").innerText    = i18n[lang]["copyAll"];
  document.getElementById("clearHistoryBtn").innerText = i18n[lang]["clearHistory"];
  document.getElementById("footNote").innerText      = i18n[lang]["footNote"];

  // Перегенерируем статусы и "months/years"
  let statusSel = document.getElementById("status");
  statusSel.innerHTML = "";
  statusOptions(lang).forEach(v => {
    let option = document.createElement("option");
    option.textContent = v;
    statusSel.appendChild(option);
  });
  document.getElementById("releaseMonth").innerHTML = makeMonths(lang).map(m=>`<option>${m}</option>`).join("");
  document.getElementById("releaseYear").innerHTML = makeYears().map(y=>`<option>${y}</option>`).join("");
}

/* ---- PART 2/4 END ---- */

            /* ---- PART 3/4 START ---- */

// --- LocalStorage helpers ---
function lsGet(key, def=[]) {
  try { return JSON.parse(localStorage.getItem(key)) ?? def } catch { return def }
}
function lsSet(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}

// ----- Глобальные переменные для custom пунктов -----
let custom = lsGet('customFields', {
  category:[], brand:[], problem:{}, diagnosis:{}, actions:{}
});

// unique push
function pushUnique(arr, val) {
  if (!arr.includes(val)) arr.push(val);
}

// --- Рендер селекторов + кастомных списков ---
function fillSelect(id, list, customList, onDel, addBtnId) {
  const sel = document.getElementById(id);
  sel.innerHTML = "";
  // Стандартные значения
  list.forEach(val => {
    let opt = document.createElement("option");
    opt.textContent = val;
    sel.appendChild(opt);
  });
  // Кастом значения
  if (customList && customList.length) {
    customList.forEach(val => {
      let opt = document.createElement("option");
      opt.textContent = val;
      opt.style.color = "#2237cc";
      sel.appendChild(opt);
    });
  }
  // Отдельно отрисуем кастомные элементы с кнопкой удаления
  let fieldListEl = document.getElementById(id+"List");
  if (fieldListEl) {
    fieldListEl.innerHTML = "";
    if (customList && customList.length) {
      customList.forEach((val, idx) => {
        let div = document.createElement("span");
        div.className = "custom-item";
        div.textContent = val;
        let del = document.createElement("button");
        del.className = "del-btn";
        del.innerText = "×";
        del.title = "Удалить";
        del.onclick = () => { onDel(idx); }
        div.appendChild(del);
        fieldListEl.appendChild(div);
      });
    }
  }
  if (addBtnId) {
    document.getElementById(addBtnId).onclick = () => {
      let newVal = prompt((modeClient ? "Enter new" : "Добавить новый")+" "+id);
      if (!newVal || newVal.length<2) return;
      pushUnique(custom[id] ?? (custom[id]=[]), newVal.trim());
      lsSet('customFields', custom);
      rebuildDynamicForm();
    }
  }
}

// Обновить все списки исходя из текущей категории
function rebuildDynamicForm() {
  let selCat = document.getElementById("category").value || categories[0].ru;
  let catEn = categories.find(c=>c.ru==selCat||c.en==selCat)?.en || selCat;
  let isRu = !modeClient;
  // Категории
  let catList = categories.map(c => isRu?c.ru:c.en);
  fillSelect("category", catList, custom.category, (idx)=>{
    custom.category.splice(idx,1); lsSet('customFields',custom); rebuildDynamicForm();
  }, "addCategoryBtn");
  // Бренды
  fillSelect("brand", brands, custom.brand, (idx)=>{
    custom.brand.splice(idx,1); lsSet('customFields',custom); rebuildDynamicForm();
  }, "addBrandBtn");
  // Проблемы
  let plist = bigProblemList(selCat);
  let plistE = modeClient ? engList(plist) : plist;
  fillSelect("problem", plistE, (custom.problem[catEn]||[]), (idx)=>{
    (custom.problem[catEn]??=[]).splice(idx,1); lsSet('customFields',custom); rebuildDynamicForm();
  }, "addProblemBtn");
  document.getElementById("addProblemBtn").onclick = () => {
    let input = prompt(modeClient?"Enter new problem":"Добавить новую проблему");
    if (!input || input.length < 2) return;
    pushUnique(custom.problem[catEn]??(custom.problem[catEn]=[]), input.trim());
    lsSet('customFields', custom);
    rebuildDynamicForm();
  };
  // Диагнозы
  let dlist = bigDiagnosisList(selCat);
  let dlistE = modeClient ? engList(dlist) : dlist;
  fillSelect("diagnosis", dlistE, (custom.diagnosis[catEn]||[]), (idx)=>{
    (custom.diagnosis[catEn]??=[]).splice(idx,1); lsSet('customFields',custom); rebuildDynamicForm();
  }, "addDiagnosisBtn");
  document.getElementById("addDiagnosisBtn").onclick = () => {
    let input = prompt(modeClient?"Enter new diagnosis":"Добавить новый диагноз");
    if (!input || input.length < 2) return;
    pushUnique(custom.diagnosis[catEn]??(custom.diagnosis[catEn]=[]), input.trim());
    lsSet('customFields', custom);
    rebuildDynamicForm();
  };
  // Действия
  let alist = bigActionsList(selCat);
  let alistE = modeClient ? engList(alist) : alist;
  fillSelect("actions", alistE, (custom.actions[catEn]||[]), (idx)=>{
    (custom.actions[catEn]??=[]).splice(idx,1); lsSet('customFields',custom); rebuildDynamicForm();
  }, "addActionsBtn");
  document.getElementById("addActionsBtn").onclick = () => {
    let input = prompt(modeClient?"Enter new action":"Добавить новое действие");
    if (!input || input.length < 2) return;
    pushUnique(custom.actions[catEn]??(custom.actions[catEn]=[]), input.trim());
    lsSet('customFields', custom);
    rebuildDynamicForm();
  };
}

// Смена языка и перегенерация формы
document.getElementById("modeClient").onchange = function() {
  modeClient = this.checked;
  switchLangUI(modeClient);
  rebuildDynamicForm();
  document.getElementById("templateOutput").value = "";
};

// Категория — динамика бренда/полей
document.getElementById("category").onchange = function() {
  rebuildDynamicForm();
  document.getElementById("brand").selectedIndex = 0;
  document.getElementById("problem").selectedIndex = 0;
  document.getElementById("diagnosis").selectedIndex = 0;
  document.getElementById("actions").selectedIndex = 0;
};

/** ---- История отчетов ---- **/

function loadReports() {
  return lsGet("reports",[]);
}
function saveReport(rep) {
  let rs = loadReports();
  rs.push(rep);
  lsSet("reports", rs);
  return rs;
}
function removeReport(idx) {
  let rs = loadReports();
  rs.splice(idx, 1);
  lsSet("reports", rs);
}
function clearReports() {
  lsSet("reports", []);
}

// --- Отрисовка истории
function renderHistory() {
  let historyBlock = document.getElementById("reportsArea");
  let rps = loadReports();
  historyBlock.innerHTML = "";
  if (!rps.length) {
    historyBlock.innerHTML = `<div style="color:#888;margin:10px 0 12px">История пуста</div>`;
    return;
  }
  rps.slice().reverse().forEach((rp, i) => {
    let ix = rps.length-1-i;
    let div = document.createElement("div");
    div.className = "report-item";
    div.innerHTML =
      `<div><b>${rp.category}</b> (${rp.brand} ${rp.model})<br>${rp.problem}, ${rp.diagnosis}, ${rp.actions}</div>
       <div>${rp.month} ${rp.year}; <b>${rp.price}</b>₽; [${rp.status}]</div>
       <div>${rp.notes?'<i>'+rp.notes+'</i>':''}</div>
      <div class="report-actions">
        <button class="small-btn copy-btn" title="Скопировать" onclick="navigator.clipboard.writeText(\`${makeTemplate(rp)}\`)">📋</button>
        <button class="small-btn del-btn" title="Удалить" onclick="removeReport(${ix});renderHistory();">🗑</button>
      </div>`;
    historyBlock.appendChild(div);
  });
}

/** ---- Генерация шаблона для клиента ---- **/
function makeTemplate(obj) {
  if (modeClient) {
    return `Category: ${obj.category}
Brand: ${obj.brand}
Model: ${obj.model}
Problem: ${obj.problem}
Diagnosis: ${obj.diagnosis}
Action: ${obj

          /* ---- PART 4/4 START ---- */
window.onload = function() {
  // Заполнение месяцев/годов
  switchLangUI(modeClient);
  document.getElementById("releaseMonth").innerHTML = makeMonths("ru").map(m=>`<option>${m}</option>`).join("");
  document.getElementById("releaseYear").innerHTML = makeYears().map(y=>`<option>${y}</option>`).join("");
  // Категории, бренды, базовые проблемы/диагнозы для первой категории
  rebuildDynamicForm();
  renderHistory();
  // Значение по умолчанию для формы
  document.getElementById("category").selectedIndex = 0;
  document.getElementById("brand").selectedIndex = 0;
  document.getElementById("problem").selectedIndex = 0;
  document.getElementById("diagnosis").selectedIndex = 0;
  document.getElementById("actions").selectedIndex = 0;
};
/* ---- PART 4/4 END ---- */
</script>
</body>
</html>
</script>
